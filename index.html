<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3-Line English ¬∑ 21 Sentences per Topic</title>

  <!-- PWA (Î£®Ìä∏ Í≤ΩÎ°ú) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4f46e5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- ‚Äª Í∏∞Ï°¥ Ïä§ÌÉÄÏùºÏùÑ Ïì∞ÏÑ∏Ïöî. (Ïó¨Í∏∞ ÏûàÎäî Ïä§ÌÉÄÏùº Î∏îÎ°ùÏùÄ ÏòàÏãúÏùº ÎøêÏù¥ÎùºÎ©¥ Ï†úÍ±∞Ìï¥ÎèÑ Îê©ÎãàÎã§) -->
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --card:#f7f7f9; --acc:#4f46e5; }
    @media (prefers-color-scheme: dark){
      :root { --fg:#eee; --muted:#aaa; --bg:#0b0b0f; --card:#121218; --acc:#818cf8; }
    }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
            Apple SD Gothic Neo, Noto Sans KR, "ÎßëÏùÄ Í≥†Îîï", sans-serif; }
    header { padding:18px 14px; border-bottom:1px solid #0001; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    header h1 { margin:0; font-size:18px; font-weight:700; letter-spacing:.2px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select, button, input[type="checkbox"] { font:inherit; }
    select, button { border:1px solid #0002; background:var(--card); color:var(--fg); padding:8px 10px; border-radius:10px; }
    button.primary { background:var(--acc); color:white; border-color:transparent; }
    main { max-width:980px; margin:0 auto; padding:24px 14px 60px; }
    .card { background:var(--card); border:1px solid #0002; border-radius:16px; padding:18px; }
    .meta { display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px; margin-bottom:10px; }
    .en { font-size:22px; font-weight:700; letter-spacing:.2px; margin:6px 0 10px; }
    .ko { font-size:18px; color:var(--muted); margin:0; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 760px){ .grid { grid-template-columns:1fr; } }
    .muted { color:var(--muted); }
    .footer { margin-top:26px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .chip { padding:4px 8px; border-radius:999px; background:#0000000c; border:1px solid #0001; }
  </style>

  <!-- topics.jsÎ•º Î®ºÏ†Ä Î°úÎìú(Ï†ÑÏó≠ window.TOPICS) -->
  <script src="./topics.js?v=fix"></script>
</head>
<body>
  <header>
    <h1>3-Line English ¬∑ 21 Sentences</h1>
    <div class="row">
      <label for="topicSel" class="muted">Topic</label>
      <select id="topicSel"></select>
      <label for="idxSel" class="muted">Sentence</label>
      <select id="idxSel"></select>
      <button id="prevBtn">‚óÄ Prev</button>
      <button id="nextBtn">Next ‚ñ∂</button>
      <button id="shuffleBtn">Shuffle</button>
      <label class="row" style="gap:6px;"><input id="hideKo" type="checkbox"> ÌïúÍ∏Ä Ïà®Í∏∞Í∏∞</label>
      <button id="resetBtn" title="Î™®Îì† Ï†ÄÏû•Îêú ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="meta">
        <span id="metaTopic" class="chip">-</span>
        <span id="metaIndex" class="chip">-</span>
        <span id="metaCount" class="muted"></span>
      </div>

      <div id="sentenceWrap">
        <div class="en" id="enText">‚Äì</div>
        <p class="ko" id="koText">‚Äì</p>
      </div>

      <div class="controls">
        <button id="speakEn" class="primary">üîä Read English</button>
        <button id="speakKo">üîä Read Korean</button>
        <button id="stopTts">‚èπ Stop</button>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="row">
          <label for="enVoiceSel" class="muted">EN Voice</label>
          <select id="enVoiceSel"></select>
        </div>
        <div class="row">
          <label for="koVoiceSel" class="muted">KO Voice</label>
          <select id="koVoiceSel"></select>
        </div>
      </div>
    </div>

    <div class="footer">
      <span class="muted">Ï†ÄÏû•Îê®: ÌòÑÏû¨ ÌÜ†ÌîΩ/Î¨∏Ïû•, ÏùåÏÑ± ÏÑ†ÌÉù</span>
      <span id="status" class="muted"></span>
    </div>
  </main>

<script>
/* -------------------- Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ -------------------- */
const TOPICS = (window.TOPICS && Array.isArray(window.TOPICS)) ? window.TOPICS : [];
if (!TOPICS.length) {
  alert('TOPICS Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§. topics.jsÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
}

// ÏïàÏ†ÑÏÑ± Ï≤¥ÌÅ¨
function validateTopics() {
  let bad = [];
  TOPICS.forEach((t,i) => {
    if (!t || !t.topic || !Array.isArray(t.sentences) || t.sentences.length !== 21) {
      bad.push(i+1); return;
    }
    for (let j=0;j<t.sentences.length;j++){
      const s = t.sentences[j];
      if (!s || !s.en || !s.ko) { bad.push(i+1); break; }
    }
  });
  if (bad.length) {
    console.warn('ÌòïÏãù Ïò§Î•ò Topics @', bad);
    document.getElementById('status').textContent = '‚ö†Ô∏è ÏùºÎ∂Ä ÌÜ†ÌîΩ ÌòïÏãù Ïò§Î•ò: ÏΩòÏÜî ÌôïÏù∏';
  }
}

/* -------------------- DOM Ï∞∏Ï°∞ -------------------- */
const elTopicSel = document.getElementById('topicSel');
const elIdxSel   = document.getElementById('idxSel');
const elHideKo   = document.getElementById('hideKo');

const elEn = document.getElementById('enText');
const elKo = document.getElementById('koText');

const elMetaTopic = document.getElementById('metaTopic');
const elMetaIndex = document.getElementById('metaIndex');
const elMetaCount = document.getElementById('metaCount');

const btnPrev   = document.getElementById('prevBtn');
const btnNext   = document.getElementById('nextBtn');
const btnShuffle= document.getElementById('shuffleBtn');
const btnReset  = document.getElementById('resetBtn');

const btnSpeakEn= document.getElementById('speakEn');
const btnSpeakKo= document.getElementById('speakKo');
const btnStop   = document.getElementById('stopTts');

const enVoiceSel= document.getElementById('enVoiceSel');
const koVoiceSel= document.getElementById('koVoiceSel');

const LSKEY = 'threeLine.v2';

/* -------------------- Ïú†Ìã∏ -------------------- */
const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
const rand  = (n)=> Math.floor(Math.random()*n);

function sortVoices(list){ return [...list].sort((a,b)=> a.name.localeCompare(b.name)); }

function saveState(state){
  try{
    localStorage.setItem(LSKEY, JSON.stringify(state));
    document.getElementById('status').textContent = 'Ï†ÄÏû•Îê®';
    setTimeout(()=>document.getElementById('status').textContent='', 1200);
  }catch(e){}
}
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LSKEY)||'{}');
    return s && typeof s==='object' ? s : {};
  }catch(e){ return {}; }
}

/* -------------------- Ï¥àÍ∏∞Ìôî -------------------- */
function populateTopicSelect(){
  elTopicSel.innerHTML = '';
  TOPICS.forEach((t, i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = `${String(i+1).padStart(2,'0')}. ${t.topic}`;
    elTopicSel.appendChild(opt);
  });
}
function populateIndexSelect(){
  elIdxSel.innerHTML = '';
  for (let i=1;i<=21;i++){
    const opt = document.createElement('option');
    opt.value = String(i-1);
    opt.textContent = `${i} / 21`;
    elIdxSel.appendChild(opt);
  }
}

function updateView(topicIdx, sentIdx){
  topicIdx = clamp(topicIdx, 0, TOPICS.length-1);
  sentIdx  = clamp(sentIdx,  0, 20);
  const t = TOPICS[topicIdx];
  const s = t.sentences[sentIdx];

  elTopicSel.value = String(topicIdx);
  elIdxSel.value   = String(sentIdx);

  elEn.textContent = s.en;
  elKo.textContent = s.ko;
  elKo.style.display = elHideKo.checked ? 'none' : '';

  elMetaTopic.textContent = `${String(topicIdx+1).padStart(2,'0')} ¬∑ ${t.topic}`;
  elMetaIndex.textContent = `#${sentIdx+1}`;
  elMetaCount.textContent = `(${t.sentences.length} sentences)`;

  saveState({ topicIdx, sentIdx,
              enVoice: enVoiceSel.value||'',
              koVoice: koVoiceSel.value||'',
              hideKo: elHideKo.checked });
}

/* -------------------- Ïù¥Î≤§Ìä∏ -------------------- */
elTopicSel.addEventListener('change', () => updateView(+elTopicSel.value, +elIdxSel.value));
elIdxSel.addEventListener('change',   () => updateView(+elTopicSel.value, +elIdxSel.value));
elHideKo.addEventListener('change',   () => updateView(+elTopicSel.value, +elIdxSel.value));

btnPrev.addEventListener('click', ()=>{
  const ti = +elTopicSel.value, si = +elIdxSel.value;
  updateView(ti, si-1 < 0 ? 20 : si-1);
});
btnNext.addEventListener('click', ()=>{
  const ti = +elTopicSel.value, si = +elIdxSel.value;
  updateView(ti, si+1 > 20 ? 0 : si+1);
});
btnShuffle.addEventListener('click', ()=>{
  updateView(rand(TOPICS.length), rand(21));
});
btnReset.addEventListener('click', ()=>{
  if (!confirm('Î°úÏª¨ Ï†ÄÏû•Îêú ÏÉÅÌÉú(ÏÑ†ÌÉù/ÏùåÏÑ± Îì±)Î•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) return;
  localStorage.removeItem(LSKEY);
  enVoiceSel.selectedIndex = 0;
  koVoiceSel.selectedIndex = 0;
  elHideKo.checked = false;
  updateView(0,0);
});

/* -------------------- TTS -------------------- */
const synth = window.speechSynthesis;
let allVoices = [];
function refreshVoices(){
  allVoices = sortVoices(synth.getVoices());
  const en = allVoices.filter(v => /en-|en_/i.test(v.lang));
  const ko = allVoices.filter(v => /ko-|ko_/i.test(v.lang));
  fillVoiceSelect(enVoiceSel, en, 'English');
  fillVoiceSelect(koVoiceSel, ko, 'Korean');
  const st = loadState();
  if (st.enVoice) enVoiceSel.value = st.enVoice;
  if (st.koVoice) koVoiceSel.value = st.koVoice;
}
function fillVoiceSelect(sel, list, label){
  sel.innerHTML = '';
  const empty = document.createElement('option');
  empty.value = '';
  empty.textContent = `Auto (${label})`;
  sel.appendChild(empty);
  list.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    sel.appendChild(opt);
  });
}
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = refreshVoices;
}
setTimeout(refreshVoices, 200);

function pickVoiceByName(name, fallbackLangRegex){
  if (name){
    const v = allVoices.find(v=>v.name===name);
    if (v) return v;
  }
  const fallback = allVoices.find(v=> fallbackLangRegex.test(v.lang));
  return fallback || null;
}
function speak(text, nameHint, langRegex){
  if (!text) return;
  if (synth.speaking) synth.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const v = pickVoiceByName(nameHint, langRegex);
  if (v) u.voice = v;
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  synth.speak(u);
}
btnSpeakEn.addEventListener('click', ()=>{
  const name = enVoiceSel.value || '';
  speak(elEn.textContent, name, /en-|en_/i);
  persistVoices();
});
btnSpeakKo.addEventListener('click', ()=>{
  const name = koVoiceSel.value || '';
  speak(elKo.textContent, name, /ko-|ko_/i);
  persistVoices();
});
btnStop.addEventListener('click', ()=> synth.cancel());
function persistVoices(){
  const st = loadState();
  st.enVoice = enVoiceSel.value||'';
  st.koVoice = koVoiceSel.value||'';
  st.hideKo  = elHideKo.checked;
  st.topicIdx = +elTopicSel.value;
  st.sentIdx  = +elIdxSel.value;
  saveState(st);
}

/* -------------------- Î∂ÄÌä∏Ïä§Ìä∏Îû© -------------------- */
(function init(){
  validateTopics();
  populateTopicSelect();
  populateIndexSelect();
  const st = loadState();
  const ti = clamp(+st.topicIdx || 0, 0, TOPICS.length-1);
  const si = clamp(+st.sentIdx  || 0, 0, 20);
  if (st.hideKo) elHideKo.checked = true;
  updateView(ti, si);
})();
</script>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PWA: ÎààÏóê Î≥¥Ïù¥Îäî UI ÏóÜÏù¥, SWÎßå Îì±Î°ù(ÌôîÎ©¥ Î≥ÄÌôî ÏóÜÏùå) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js', { scope: './' })
      .catch(err => console.warn('SW register failed', err));
  });
}
// Ï£ºÏÑù: beforeinstallprompt UIÎ•º Îî∞Î°ú ÎßåÎì§ÏßÄ ÏïäÏäµÎãàÎã§(=ÌôîÎ©¥ Î≥ÄÌôî X).
// AndroidÎäî Î∏åÎùºÏö∞Ï†Ä Í∏∞Î≥∏ ÎèôÏûë(ÌïòÎã® ÌÜ†Ïä§Ìä∏/Ïò§Î≤ÑÌîåÎ°ú Î©îÎâ¥Ïùò "Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä"),
// iOSÎäî SafariÏùò Í≥µÏú†‚ÜíÌôà ÌôîÎ©¥Ïóê Ï∂îÍ∞ÄÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.
</script>
</body>
</html>
